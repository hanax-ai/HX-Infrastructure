#!/bin/bash
# HX Infrastructure Metrics Backup Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

BACKUP_DIR="{{ hx_metrics_backup_dir }}"
DATA_DIR="{{ hx_metrics_prometheus_data_dir }}"
TIMESTAMP="{{ hx_metrics_backup_ts }}"
RETENTION_DAYS="{{ hx_metrics_backup_retention_days }}"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Create backup
echo "Starting HX Metrics backup at $(date)"
tar -czf "$BACKUP_DIR/prometheus-data-$TIMESTAMP.tar.gz" -C "$DATA_DIR" .

# Clean old backups
find "$BACKUP_DIR" -name "prometheus-data-*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "HX Metrics backup completed at $(date)"
